
  <!DOCTYPE html>
  <html>
    <head>
      <title>GenerateContainer.tsx</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="..\..\..\assets\source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="..\..\..\assets\source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="..\..\..\index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">pages\generate\GenerateContainer.tsx</td><td class="">73.44%</td><td class="">99%</td><td class="">241</td><td class="">177</td><td class="">64</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import useAxios from &#x27;axios-hooks&#x27;;
import moment from &#x27;moment&#x27;;
import { useRouter } from &#x27;next/router&#x27;;
import { useCallback, useEffect, useState } from &#x27;react&#x27;;
import Api from &#x27;../../apis/index&#x27;;
import useAlert from &#x27;../../hooks/useAlert&#x27;;
import GenerateView from &#x27;./GenerateView&#x27;;

const apiSetting = new Api();

function GenerateContainer() {
    const router = useRouter();
    const { setAlert } = useAlert();
    const [document, setDocument] = useState&lt;any&gt;();
    const [documents_items, setDocumentsItems] = useState&lt;any&gt;([]);
    const [generateContent, setGenerateContent] = useState(&#x27;&#x27;);
    const [open, setOpen] = useState(false);
    const [modalDescription, setModalDescription] = useState({});
    const [logs, setLogs] = useState&lt;any&gt;([]);

    const [{ data: getCollectionDocumentsData }, getCollectionDocuments] = useAxios(
        apiSetting.Document.getCollectionDocuments(),
        {
            manual: true
        }
    );

    const [{ data: getGenerateData }, getGenerate] = useAxios(&#x27;&#x27;, { manual: true });
    const [{ data: uploadGeneratedContentData }, uploadGeneratedContent] = useAxios(&#x27;&#x27;, {
        manual: true
    });

    useEffect(() =&gt; {
        if (router.query.document_ids) {
            setOpen(true);
            setModalDescription({
                title: &#x27;加載中......&#x27;,
                content: &#x27;正在加載文件...&#x27;
            });
            setDocumentsItems([]);
            getCollectionDocuments({
                params: {
                    ids: router.query.document_ids.toString().split(&#x27;,&#x27;)
                }
            });
        }
    }, [router.query.document_ids]);

    useEffect(() =&gt; {
        if (getCollectionDocumentsData &amp;&amp; getCollectionDocumentsData.success === true) {
            setDocumentsItems(getCollectionDocumentsData.documents);
            setOpen(false);
        } else if (getCollectionDocumentsData &amp;&amp; getCollectionDocumentsData.success === false) {
            setAlert({ title: getCollectionDocumentsData.error, type: &#x27;error&#x27; });
            setOpen(false);
        }
    }, [router, getCollectionDocumentsData]);

    const handleQuery = useCallback(
        async (query: string, format: string, language: string, topic: string, style: string) =&gt; {
            if (documents_items &amp;&amp; documents_items?.length &lt;= 0) {
                setAlert({ title: &#x27;請選擇文件&#x27;, type: &#x27;info&#x27; });
                return;
            }

            setOpen(true);
            setModalDescription({
                title: &#x27;進行中......&#x27;,
                content: &#x27;正在生成內容...&#x27;
            });

            const document_ids = documents_items.map((item: any) =&gt; {
                return item.id;
            });

            const maxRetry = 2;

            const tryQuery: any = async (retryCount = 0) =&gt; {
                try {
                    const res = await getGenerate(
                        apiSetting.Generate.queryByDocuments(
                            document_ids,
                            query,
                            format,
                            language,
                            topic,
                            style
                        )
                    );
                    return res;
                } catch (error) {
                    if (retryCount &gt;= maxRetry) throw error;
                    return tryQuery(retryCount + 1);
                }
            };

            try {
                const res = await tryQuery();
                setOpen(false);

                if (res.data?.success) {
                    const newLog = {
                        content: res.data?.response?.content,
                        format: format,
                        language: language,
                        topic: topic,
                        style: style,
                        created_at: moment().format(),
                        email: localStorage.getItem(&#x27;email&#x27;)
                    };

                    setLogs((arr: any) =&gt; [...arr, newLog]);
                    setGenerateContent(res.data?.response?.content);
                } else {
                    setAlert({ title: &#x27;網絡發生錯誤，請稍後再試&#x27;, type: &#x27;error&#x27; });
                }
            } catch (error) {
                setOpen(false);
                setAlert({ title: &#x27;網絡發生錯誤，請稍後再試&#x27;, type: &#x27;error&#x27; });
            }
        },
        [router, documents_items]
    );

    const handleUploadGeneratedData = useCallback(
        async (data: any) =&gt; {
            console.log(data);
            setOpen(true);
            setModalDescription({
                title: &#x27;進行中......&#x27;,
                content: &#x27;正在儲存內容...&#x27;
            });
            const formData = new FormData();
            formData.append(&#x27;filename&#x27;, data.filename);
            formData.append(&#x27;target_folder_id&#x27;, data.target_folder_id);
            formData.append(&#x27;content&#x27;, data.content);
            const res = await uploadGeneratedContent(
                apiSetting.Storage.uploadGeneratedContent(
                    data.filename,
                    data.target_folder_id,
                    data.content
                )
            );
            if (res.data?.success) {
                setAlert({ title: &#x27;儲存成功&#x27;, type: &#x27;success&#x27; });
            } else {
                setAlert({ title: res.data?.error, type: &#x27;error&#x27; });
            }
            setOpen(false);
        },
        [router]
    );
    return (
        &lt;&gt;
            &lt;GenerateView
                {...{
                    documents_items,
                    setDocumentsItems,
                    handleQuery,
                    open,
                    setOpen,
                    generateContent,
                    setGenerateContent,
                    setAlert,
                    logs,
                    modalDescription,
                    handleUploadGeneratedData
                }}
            /&gt;
        &lt;/&gt;
    );
}

export default GenerateContainer;
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:13,&quot;character&quot;:11,&quot;text&quot;:&quot;document&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:14,&quot;character&quot;:11,&quot;text&quot;:&quot;documents_items&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:18,&quot;character&quot;:11,&quot;text&quot;:&quot;logs&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:20,&quot;character&quot;:19,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:27,&quot;character&quot;:19,&quot;text&quot;:&quot;getGenerateData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:28,&quot;character&quot;:19,&quot;text&quot;:&quot;uploadGeneratedContentData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:49,&quot;character&quot;:12,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:49,&quot;character&quot;:42,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:49,&quot;character&quot;:69,&quot;text&quot;:&quot;success&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:50,&quot;character&quot;:30,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:50,&quot;character&quot;:57,&quot;text&quot;:&quot;documents&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:52,&quot;character&quot;:19,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:52,&quot;character&quot;:49,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:52,&quot;character&quot;:76,&quot;text&quot;:&quot;success&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:53,&quot;character&quot;:30,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:53,&quot;character&quot;:57,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:56,&quot;character&quot;:16,&quot;text&quot;:&quot;getCollectionDocumentsData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:16,&quot;text&quot;:&quot;documents_items&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:35,&quot;text&quot;:&quot;documents_items&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:52,&quot;text&quot;:&quot;length&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:71,&quot;character&quot;:18,&quot;text&quot;:&quot;document_ids&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:71,&quot;character&quot;:33,&quot;text&quot;:&quot;documents_items&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:71,&quot;character&quot;:49,&quot;text&quot;:&quot;map&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:71,&quot;character&quot;:54,&quot;text&quot;:&quot;item&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:72,&quot;character&quot;:23,&quot;text&quot;:&quot;item&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:72,&quot;character&quot;:28,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:77,&quot;character&quot;:18,&quot;text&quot;:&quot;tryQuery&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:92,&quot;character&quot;:27,&quot;text&quot;:&quot;tryQuery&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:97,&quot;character&quot;:22,&quot;text&quot;:&quot;res&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:97,&quot;character&quot;:34,&quot;text&quot;:&quot;tryQuery&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:100,&quot;character&quot;:20,&quot;text&quot;:&quot;res&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:100,&quot;character&quot;:24,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:100,&quot;character&quot;:30,&quot;text&quot;:&quot;success&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:24,&quot;text&quot;:&quot;content&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:33,&quot;text&quot;:&quot;res&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:37,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:43,&quot;text&quot;:&quot;response&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:53,&quot;text&quot;:&quot;content&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:111,&quot;character&quot;:29,&quot;text&quot;:&quot;arr&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:111,&quot;character&quot;:46,&quot;text&quot;:&quot;arr&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:112,&quot;character&quot;:39,&quot;text&quot;:&quot;res&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:112,&quot;character&quot;:43,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:112,&quot;character&quot;:49,&quot;text&quot;:&quot;response&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:112,&quot;character&quot;:59,&quot;text&quot;:&quot;content&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:121,&quot;character&quot;:17,&quot;text&quot;:&quot;documents_items&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:125,&quot;character&quot;:15,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:126,&quot;character&quot;:24,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:133,&quot;character&quot;:40,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:133,&quot;character&quot;:45,&quot;text&quot;:&quot;filename&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:134,&quot;character&quot;:48,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:134,&quot;character&quot;:53,&quot;text&quot;:&quot;target_folder_id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:135,&quot;character&quot;:39,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:135,&quot;character&quot;:44,&quot;text&quot;:&quot;content&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:138,&quot;character&quot;:20,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:138,&quot;character&quot;:25,&quot;text&quot;:&quot;filename&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:139,&quot;character&quot;:20,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:139,&quot;character&quot;:25,&quot;text&quot;:&quot;target_folder_id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:140,&quot;character&quot;:20,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:140,&quot;character&quot;:25,&quot;text&quot;:&quot;content&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:143,&quot;character&quot;:20,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:143,&quot;character&quot;:26,&quot;text&quot;:&quot;success&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:146,&quot;character&quot;:38,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:146,&quot;character&quot;:44,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;pages\\generate\\GenerateContainer.tsx&quot;,&quot;line&quot;:164,&quot;character&quot;:20,&quot;text&quot;:&quot;logs&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 03 Aug 2023 09:19:42 GMT</p>
    </body>
  </html>
  